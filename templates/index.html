<!-- htmlhint-disable -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GES DAaaS</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --card2:#0c1628;
      --text:#e9eefc;
      --muted:#a9b7da;
      --border:rgba(255,255,255,.10);
      --shadow: 0 12px 35px rgba(0,0,0,.35);
      --accent:#6ea8fe;
      --accent2:#9b7bff;
      --good:#31d0aa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 10%, rgba(110,168,254,.22), transparent 60%),
                  radial-gradient(1000px 700px at 80% 30%, rgba(155,123,255,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:28px 18px 40px;}
    .top{
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px;
      margin-bottom:18px;
    }
    .title h1{margin:0; font-size:38px; letter-spacing:.2px;}
    .title p{margin:8px 0 0; color:var(--muted); line-height:1.35}
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:10px 12px; border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:99px; background:var(--good); box-shadow:0 0 0 6px rgba(49,208,170,.12);}

    .nav-tabs-custom{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom:20px;
      border-bottom:1px solid var(--border);
      padding-bottom:10px;
    }
    .nav-tab-link{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 14px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      text-decoration:none;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .nav-tab-link:hover{background: rgba(255,255,255,.08); color:var(--text);}
    .nav-tab-link:active{transform: translateY(1px)}
    .nav-tab-link.active{
      border-color: rgba(110,168,254,.65);
      background: linear-gradient(90deg, rgba(110,168,254,.22), rgba(155,123,255,.18));
      color:var(--text);
    }
    .tab-pane{display:none;}
    .tab-pane.active{display:block;}

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; margin-bottom:14px;}
    @media (max-width: 900px){ .grid{grid-template-columns: 1fr;} .top{flex-direction:column; align-items:flex-start;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--border);
    }
    .card-h h2{margin:0; font-size:16px; font-weight:700;}
    .card-h span{color:var(--muted); font-size:13px;}
    .card-b{padding:14px 16px;}
    .meta{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .pill{
      border:1px solid var(--border);
      background: rgba(0,0,0,.15);
      border-radius: 14px;
      padding:10px 12px;
    }
    .pill .k{color:var(--muted); font-size:12px; margin-bottom:6px;}
    .pill .v{font-weight:700; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    /* Tabs */
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 10px 0 2px;
    }
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .tab:hover{background: rgba(255,255,255,.07)}
    .tab:active{transform: translateY(1px)}
    .tab.active{
      border-color: rgba(110,168,254,.55);
      background: linear-gradient(90deg, rgba(110,168,254,.18), rgba(155,123,255,.14));
    }
    .note{color:var(--muted); font-size:13px; margin:10px 0 0;}

    /* Table card */
    .table-card{
      margin-top:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .toolbar .left{display:flex; flex-direction:column; gap:4px; min-width:0;}
    .toolbar .left .line1{font-weight:700; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .toolbar .left .line2{color:var(--muted); font-size:12px;}
    .actions{display:flex; gap:10px; align-items:center;}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      text-decoration:none;
      transition: background .2s ease, border-color .2s ease;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn.primary{
      border-color: rgba(110,168,254,.55);
      background: linear-gradient(90deg, rgba(110,168,254,.22), rgba(155,123,255,.18));
    }
    select.btn{
      color:var(--text);
    }
    select.btn option{
      background: var(--card);
      color:var(--text);
    }

    .table-wrap{
      max-height: 62vh;
      overflow:auto;
      background: rgba(0,0,0,.12);
    }
    table{width:100%; border-collapse:separate; border-spacing:0;}
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:13px;
    }
    th{
      position:sticky; top:0; z-index:2;
      background: rgba(15,26,46,.95);
      color: var(--text);
      text-align:left;
      font-size:12px;
      letter-spacing:.3px;
      text-transform: none;
    }
    tr:hover td{background: rgba(255,255,255,.03)}
    .muted{color:var(--muted)}
    .chart-box{
      background: rgba(0,0,0,.2);
      padding:16px;
      border-radius:12px;
      border:1px solid var(--border);
    }
    .metric-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>GES Cloud-based Analytics Platform</h1>
        <p>Graduate Employment Survey - Data Analysis & Visualization</p>
      </div>
      <div class="badge"><span class="dot"></span> Live Analytics</div>
    </div>

    <!-- Navigation Tabs -->
    {% set active_tab = active_tab or 'overview' %}
    <div class="nav-tabs-custom">
      <a class="nav-tab-link {% if active_tab == 'overview' %}active{% endif %}" href="{{ url_for('index') }}">üìã Overview</a>
      <a class="nav-tab-link {% if active_tab == 'tab1' %}active{% endif %}" href="{{ url_for('function1') }}">üìä Trend Analysis</a>
      <a class="nav-tab-link {% if active_tab == 'tab2' %}active{% endif %}" href="{{ url_for('function2') }}">üìà IQR Analysis</a>
      <a class="nav-tab-link {% if active_tab == 'tab3' %}active{% endif %}" href="{{ url_for('function3') }}">üîç Rankings</a>
      <a class="nav-tab-link {% if active_tab == 'tab4' %}active{% endif %}" href="{{ url_for('function4') }}">üíº Employment vs Salary</a>
      <a class="nav-tab-link {% if active_tab == 'tab5' %}active{% endif %}" href="{{ url_for('function5') }}">üöÄ Salary Projection</a>
    </div>

    <!-- Tab Content -->
    <!-- Overview Tab -->
    <div class="tab-pane {% if active_tab == 'overview' %}active{% endif %}" id="overview">
    <div class="grid">
      <div class="card">
        <div class="card-h">
          <div>
            <h2>Dataset Controls</h2>
            <span>Choose a dataset to preview (first 50 rows).</span>
          </div>
        </div>
        <div class="card-b">
          <div class="tabs">
            <div id="tab-processed" class="tab active" onclick="loadCSV('/data/cleaned.csv','Processed (cleaned.csv)')">
              Processed
            </div>
            <div id="tab-raw" class="tab" onclick="loadCSV('/data/raw.csv','Raw (raw.csv)')">
              Raw
            </div>
          </div>
          <div class="note">Tip: Preview is limited to 50 rows for speed. Use Download for the full CSV.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <h2>File Summary</h2>
            <span>Updates when you switch datasets.</span>
          </div>
        </div>
        <div class="card-b">
          <div class="meta">
            <div class="pill">
              <div class="k">Selected</div>
              <div class="v" id="selected">Processed (cleaned.csv)</div>
            </div>
            <div class="pill">
              <div class="k">File size</div>
              <div class="v" id="filesize">‚Äî</div>
            </div>
            <div class="pill">
              <div class="k">Total rows</div>
              <div class="v" id="totalrows">‚Äî</div>
            </div>
          </div>
          <div class="note" id="status">Ready.</div>
        </div>
      </div>
    </div>

    <div class="table-card">
      <div class="toolbar">
        <div class="left">
          <div class="line1" id="tableTitle">Processed (cleaned.csv)</div>
          <div class="line2"><span class="muted">Preview:</span> first 50 rows</div>
        </div>
        <div class="actions">
          <a id="downloadBtn" class="btn primary" href="/data/cleaned.csv" download>Download CSV</a>
        </div>
      </div>

      <div class="table-wrap">
        <table id="table"></table>
      </div>
    </div>
    </div>
    <!-- End Overview Tab -->

    <!-- Tab 1: Trend Analysis -->
    <div class="tab-pane {% if active_tab == 'tab1' %}active{% endif %}" id="tab1">
      <div class="card">
        <div class="card-h">
          <h2>Graduate Employment Trend Analysis</h2>
          <span>Analyze employment rate and salary trends over time</span>
        </div>
        <div class="card-b">
          <form method="GET" action="{{ url_for('function1') }}">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px">
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">University</label>
                <select name="university" id="universitySelect" onchange="updateSchools()" class="btn" style="width:100%; text-align:left">
                  <option value="">-- Select University --</option>
                  {% for uni in universities %}
                  <option value="{{ uni }}" {% if selected_university == uni %}selected{% endif %}>{{ uni }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">School (Optional)</label>
                <select name="school" id="schoolSelect" onchange="updateDegrees()" class="btn" style="width:100%; text-align:left">
                  <option value="">-- All Schools --</option>
                  {% for sch in schools %}
                  <option value="{{ sch }}" {% if selected_school == sch %}selected{% endif %}>{{ sch }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Degree (Optional)</label>
                <select name="degree" id="degreeSelect" class="btn" style="width:100%; text-align:left">
                  <option value="">-- All Degrees --</option>
                  {% for deg in degrees %}
                  <option value="{{ deg }}" {% if selected_degree == deg %}selected{% endif %}>{{ deg }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Rolling Window</label>
                <select name="rolling_window" class="btn" style="width:100%; text-align:left">
                  <option value="2" {% if rolling_window == 2 %}selected{% endif %}>2 years</option>
                  <option value="3" {% if rolling_window == 3 %}selected{% endif %}>3 years</option>
                  <option value="5" {% if rolling_window == 5 %}selected{% endif %}>5 years</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn primary">Analyze Trends</button>
          </form>
          
          {% if active_tab == 'tab1' and data %}
          <!-- Trend Charts -->
          <div style="margin-top:24px">
            <h3 style="font-size:16px; margin-bottom:16px">Trend Visualizations</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px">
              <div style="background:rgba(0,0,0,.2); padding:16px; border-radius:12px; border:1px solid var(--border)">
                <canvas id="employmentChart"></canvas>
              </div>
              <div style="background:rgba(0,0,0,.2); padding:16px; border-radius:12px; border:1px solid var(--border)">
                <canvas id="ftPermChart"></canvas>
              </div>
            </div>
            <div style="background:rgba(0,0,0,.2); padding:16px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px">
              <canvas id="salaryChart"></canvas>
            </div>
          </div>

          <div style="margin-top:20px">
            <h3 style="font-size:16px; margin-bottom:12px">Trend Data</h3>
            <div class="table-wrap" style="max-height:60vh">
              <table>
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>Employment Rate (%)</th>
                    <th>YoY Change (%)</th>
                    <th>Moving Avg</th>
                    <th>FT Perm Rate (%)</th>
                    <th>YoY Change (%)</th>
                    <th>Moving Avg</th>
                    <th>Median Salary ($)</th>
                    <th>YoY Change ($)</th>
                    <th>Moving Avg ($)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in data %}
                  <tr>
                    <td><strong>{{ row.year }}</strong></td>
                    <td>{{ "%.2f"|format(row.employment_rate_overall) }}</td>
                    <td style="color:{% if row.employment_rate_overall_yoy_pct > 0 %}#31d0aa{% else %}#ff6b6b{% endif %}">
                      {{ "%.2f"|format(row.employment_rate_overall_yoy_pct) if row.employment_rate_overall_yoy_pct else '-' }}
                    </td>
                    <td>{{ "%.2f"|format(row['employment_rate_overall_ma' ~ rolling_window]) }}</td>
                    <td>{{ "%.2f"|format(row.employment_rate_ft_perm) }}</td>
                    <td style="color:{% if row.employment_rate_ft_perm_yoy_pct > 0 %}#31d0aa{% else %}#ff6b6b{% endif %}">
                      {{ "%.2f"|format(row.employment_rate_ft_perm_yoy_pct) if row.employment_rate_ft_perm_yoy_pct else '-' }}
                    </td>
                    <td>{{ "%.2f"|format(row['employment_rate_ft_perm_ma' ~ rolling_window]) }}</td>
                    <td>${{ "%.2f"|format(row.gross_monthly_median) }}</td>
                    <td style="color:{% if row.gross_monthly_median_yoy_abs > 0 %}#31d0aa{% else %}#ff6b6b{% endif %}">
                      ${{ "%.2f"|format(row.gross_monthly_median_yoy_abs) if row.gross_monthly_median_yoy_abs else '-' }}
                    </td>
                    <td>${{ "%.2f"|format(row['gross_monthly_median_ma' ~ rolling_window]) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- End Tab 1 -->

    <!-- Tab 2: IQR Analysis -->
    <div class="tab-pane {% if active_tab == 'tab2' %}active{% endif %}" id="tab2">
      {% if active_tab == 'tab2' %}
      <div class="grid">
        <!-- Top 5 IQR -->
        <div class="card">
          <div class="card-h">
            <div>
              <h2>Top 5 IQR</h2>
              <span>Highest salary spread (75th - 25th percentile)</span>
            </div>
            <span class="metric-badge">IQR = P75 ‚àí P25</span>
          </div>
          <div class="card-b">
            <div class="table-wrap" style="max-height:55vh">
              <table>
                <thead>
                  <tr>
                    <th>Degree</th>
                    <th>University</th>
                    <th>Year</th>
                    <th>IQR</th>
                    <th>25th</th>
                    <th>75th</th>
                  </tr>
                </thead>
                <tbody>
                  {% if top_iqr and top_iqr|length > 0 %}
                    {% for row in top_iqr %}
                    <tr>
                      <td>{{ row.degree }}</td>
                      <td>{{ row.university }}</td>
                      <td>{{ row.year }}</td>
                      <td><strong>{{ row.IQR }}</strong></td>
                      <td>{{ row.gross_mthly_25_percentile }}</td>
                      <td>{{ row.gross_mthly_75_percentile }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="6" class="muted">No Top IQR data available.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Top 5 IQR Ratio -->
        <div class="card">
          <div class="card-h">
            <div>
              <h2>Top 5 IQR Ratio</h2>
              <span>Spread relative to median salary</span>
            </div>
            <span class="metric-badge">IQR Ratio = IQR √∑ Median</span>
          </div>
          <div class="card-b">
            <div class="table-wrap" style="max-height:55vh">
              <table>
                <thead>
                  <tr>
                    <th>Degree</th>
                    <th>University</th>
                    <th>Year</th>
                    <th>IQR Ratio</th>
                    <th>25th</th>
                    <th>75th</th>
                  </tr>
                </thead>
                <tbody>
                  {% if top_iqr_ratio and top_iqr_ratio|length > 0 %}
                    {% for row in top_iqr_ratio %}
                    <tr>
                      <td>{{ row.degree }}</td>
                      <td>{{ row.university }}</td>
                      <td>{{ row.year }}</td>
                      <td><strong>{{ "%.4f"|format(row.IQR_ratio) }}</strong></td>
                      <td>{{ row.gross_mthly_25_percentile }}</td>
                      <td>{{ row.gross_mthly_75_percentile }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="6" class="muted">No Top IQR Ratio data available.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="table-card">
        <div class="toolbar">
          <div class="left">
            <div class="line1">All IQR Records</div>
            <div class="line2"><span class="muted">Full dataset for reference</span></div>
          </div>
        </div>
        <div class="table-wrap" style="max-height:65vh">
          <table>
            <thead>
              <tr>
                <th>Degree</th>
                <th>University</th>
                <th>Year</th>
                <th>IQR</th>
                <th>IQR Ratio</th>
              </tr>
            </thead>
            <tbody>
              {% if data and data|length > 0 %}
                {% for row in data %}
                <tr>
                  <td>{{ row.degree }}</td>
                  <td>{{ row.university }}</td>
                  <td>{{ row.year }}</td>
                  <td>{{ row.IQR }}</td>
                  <td>{{ row.IQR_ratio }}</td>
                </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="5" class="muted">No data available.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      {% endif %}
    </div>


    <!-- Tab 3: Function 3 -->
    <div class="tab-pane {% if active_tab == 'tab3' %}active{% endif %}" id="tab3">
      <div class="card">
        <div class="card-h">
          <div>
            <h2>Rankings</h2>
            <span>Top/Bottom degrees by median salary and change from previous year</span>
          </div>
        </div>

        <div class="card-b">
          <form method="GET" action="{{ url_for('function3') }}" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-bottom:14px">
            <div>
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Year</label>
              <select name="year" class="btn" style="width:100%; text-align:left">
                {% for y in years %}
                  <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Order</label>
              <select name="mode" class="btn" style="width:100%; text-align:left">
                <option value="top" {% if selected_mode == 'top' %}selected{% endif %}>Highest salaries</option>
                <option value="bottom" {% if selected_mode == 'bottom' %}selected{% endif %}>Lowest salaries</option>
              </select>
            </div>

            <div>
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Number of results</label>
              <select name="n" class="btn" style="width:100%; text-align:left">
                {% for opt in [5,10,15,20] %}
                  <option value="{{ opt }}" {% if selected_n == opt %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Group</label>
              <select name="group_by" class="btn" style="width:100%; text-align:left">
                <option value="degree" {% if selected_group_by == 'degree' %}selected{% endif %}>Degree</option>
                <option value="degree_university" {% if selected_group_by == 'degree_university' %}selected{% endif %}>Degree + University</option>
              </select>
            </div>

            <div style="grid-column: 1 / -1; display:flex; align-items:center; margin-top:4px">
              <label class="muted" style="display:flex; gap:8px; align-items:center; font-size:13px; margin:0">
                <input type="checkbox" name="include_most_improved" value="1" {% if include_most_improved %}checked{% endif %}>
                Show degree with most improved salaries
              </label>
              <button type="submit" class="btn primary" style="margin-left:auto">Run</button>
            </div>
          </form>

          {% if rank_rows and rank_rows|length > 0 %}
          <div class="table-wrap" style="max-height:55vh; margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Degree</th>
                  {% if selected_group_by == 'degree_university' %}<th>University</th>{% endif %}
                  <th>Median Salary</th>
                  <th>Prev Year Median</th>
                  <th>Œîrank</th>
                  <th>% Change</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rank_rows %}
                <tr>
                  <td><strong>{{ row.rank }}</strong></td>
                  <td>{{ row.degree }}</td>
                  {% if selected_group_by == 'degree_university' %}<td>{{ row.university }}</td>{% endif %}
                  <td>${{ "%.2f"|format(row.median_salary) }}</td>
                  <td>
                    {% if row.prev_median_salary is not none %}
                      ${{ "%.2f"|format(row.prev_median_salary) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td style="color:{% if row.delta_rank is not none and row.delta_rank > 0 %}#31d0aa{% elif row.delta_rank is not none and row.delta_rank < 0 %}#ff6b6b{% else %}#a9b7da{% endif %}">
                    {% if row.delta_rank is not none %}{{ row.delta_rank }}{% else %}-{% endif %}
                  </td>
                  <td style="color:{% if row.pct_change_salary is not none and row.pct_change_salary > 0 %}#31d0aa{% elif row.pct_change_salary is not none and row.pct_change_salary < 0 %}#ff6b6b{% else %}#a9b7da{% endif %}">
                    {% if row.pct_change_salary is not none %}{{ "%.2f"|format(row.pct_change_salary) }}%{% else %}-{% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p class="muted">No results yet. Choose year and click Run.</p>
          {% endif %}

          {% if include_most_improved and most_improved and most_improved|length > 0 %}
          <div style="margin-top:18px">
            <h3 style="font-size:14px; margin:0 0 10px">Most improved</h3>
            <div class="table-wrap" style="max-height:40vh">
              <table>
                <thead>
                  <tr>
                    <th>Degree</th>
                    {% if selected_group_by == 'degree_university' %}<th>University</th>{% endif %}
                    <th>Rank</th>
                    <th>Prev Rank</th>
                    <th>Œîrank</th>
                    <th>Median Salary</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in most_improved %}
                  <tr>
                    <td>{{ row.degree }}</td>
                    {% if selected_group_by == 'degree_university' %}<td>{{ row.university }}</td>{% endif %}
                    <td>{{ row.rank }}</td>
                    <td>{% if row.prev_rank is not none %}{{ row.prev_rank }}{% else %}-{% endif %}</td>
                    <td style="color:#31d0aa; font-weight:700">
                      {% if row.delta_rank is not none %}{{ row.delta_rank }}{% else %}-{% endif %}
                    </td>
                    <td>${{ "%.2f"|format(row.median_salary) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

        </div>
      </div>
    </div>

    <!-- Tab 5: Salary Projection -->
    <div class="tab-pane {% if active_tab == 'tab5' %}active{% endif %}" id="tab5">
      {% if active_tab == 'tab5' %}
      <div class="card">
        <div class="card-h">
          <h2>Salary Projection for 2024</h2>
          <span>Linear trend extrapolation using last N years (N=2-5)</span>
        </div>
        <div class="card-b">
          <!-- Filters -->
          <form method="GET" action="{{ url_for('function5') }}" id="function5Form" style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px; margin-bottom:16px">
            <div>
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">University (Optional)</label>
              <select name="university" id="universitySelectF5" onchange="updateDegreesF5()" class="btn" style="width:100%; text-align:left">
                <option value="">-- All Universities --</option>
                {% for uni in universities %}
                <option value="{{ uni }}" {% if selected_university == uni %}selected{% endif %}>{{ uni }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Degree (Optional)</label>
              <select name="degree" id="degreeSelectF5" class="btn" style="width:100%; text-align:left">
                <option value="">-- All Degrees --</option>
                {% for deg in degrees %}
                <option value="{{ deg }}" {% if selected_degree == deg %}selected{% endif %}>{{ deg }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Trend</label>
              <select name="trend_filter" class="btn" style="width:100%; text-align:left">
                <option value="all" {% if selected_trend_filter == 'all' %}selected{% endif %}>All Trends</option>
                <option value="increasing" {% if selected_trend_filter == 'increasing' %}selected{% endif %}>Increasing Only</option>
                <option value="decreasing" {% if selected_trend_filter == 'decreasing' %}selected{% endif %}>Decreasing Only</option>
              </select>
            </div>
            <div>
              <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Show Top</label>
              <select name="limit" class="btn" style="width:100%; text-align:left">
                <option value="" {% if not selected_limit %}selected{% endif %}>All Results</option>
                <option value="10" {% if selected_limit == 10 %}selected{% endif %}>Top 10</option>
                <option value="20" {% if selected_limit == 20 %}selected{% endif %}>Top 20</option>
                <option value="50" {% if selected_limit == 50 %}selected{% endif %}>Top 50</option>
              </select>
            </div>
            <div style="grid-column:1/-1">
              <button type="submit" class="btn primary">Apply Filters</button>
            </div>
          </form>

          {% if data and data|length > 0 %}
          <!-- Chart -->
          <div style="background:rgba(0,0,0,.2); padding:16px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px">
            <canvas id="projectionChart"></canvas>
          </div>
          {% endif %}
          <div class="table-wrap" style="max-height:70vh">
            <table>
              <thead>
                <tr>
                  <th>Degree</th>
                  <th>University</th>
                  <th>Method</th>
                  <th>Last Year</th>
                  <th>Last Actual Median ($)</th>
                  <th>Predicted 2024 ($)</th>
                  <th>Change ($)</th>
                  <th>Change (%)</th>
                  <th>Trend Slope</th>
                </tr>
              </thead>
              <tbody>
                {% for row in data %}
                <tr>
                  <td>{{ row.degree }}</td>
                  <td>{{ row.university }}</td>
                  <td><small>{{ row.method }}</small></td>
                  <td>{{ row.last_year }}</td>
                  <td>${{ "%.2f"|format(row.last_actual_median) }}</td>
                  <td style="font-weight:700">${{ "%.2f"|format(row.predicted_median_2024) }}</td>
                  <td style="color:{% if row.change_amount > 0 %}#31d0aa{% else %}#ff6b6b{% endif %}">${{ "%.2f"|format(row.change_amount) }}</td>
                  <td style="color:{% if row.change_percentage > 0 %}#31d0aa{% else %}#ff6b6b{% endif %}">{{ "%.2f"|format(row.change_percentage) }}%</td>
                  <td>{{ "%.2f"|format(row.trend_slope) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Tab 4: Employment vs Salary -->
    <div class="tab-pane {% if active_tab == 'tab4' %}active{% endif %}" id="tab4">
      {% if active_tab == 'tab4' %}
      <div class="card">
        <div class="card-h">
          <h2>Employment Rate vs Salary</h2>
        </div>
        <div class="card-b">
          <form method="GET" action="{{ url_for('function4') }}" style="margin-bottom:14px">
            <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:12px; align-items:end">
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">University</label>
                <select name="university" class="btn" style="width:100%; text-align:left">
                  {% for uni in universities %}
                  <option value="{{ uni }}" {% if selected_university == uni %}selected{% endif %}>{{ uni }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label style="display:block; color:var(--muted); font-size:12px; margin-bottom:6px">Degree</label>
                <select name="degree" class="btn" style="width:100%; text-align:left">
                  {% for deg in degrees %}
                  <option value="{{ deg }}" {% if selected_degree == deg %}selected{% endif %}>{{ deg }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <button type="submit" class="btn primary">Show Trend</button>
              </div>
            </div>
          </form>

          <div class="chart-box">
            <canvas id="employmentSalaryTrend"></canvas>
          </div>
        </div>
      </div>

      <div class="table-card">
        <div class="toolbar">
          <div class="left">
            <div class="line1">Supporting Trend Data</div>
            <div class="line2"><span class="muted">Yearly median salary and average employment rate</span></div>
          </div>
        </div>
        <div class="table-wrap" style="max-height:70vh">
          <table>
            <thead>
              <tr>
                <th>Year</th>
                <th>Employment Rate Overall</th>
                <th>Gross Monthly Median</th>
              </tr>
            </thead>
            <tbody>
              {% for row in data %}
              <tr>
                <td>{{ row.year }}</td>
                <td>{{ "%.2f"|format(row.employment_rate_overall) }}</td>
                <td>${{ "%.2f"|format(row.gross_monthly_median) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>


  </div>
  <!-- End wrap -->

  <script>
    // Global functions for dropdown cascading (used in tab1)
    async function updateSchools() {
      const university = document.getElementById('universitySelect').value;
      const schoolSelect = document.getElementById('schoolSelect');
      const degreeSelect = document.getElementById('degreeSelect');
      
      // Clear schools and degrees
      schoolSelect.innerHTML = '<option value="">-- All Schools --</option>';
      degreeSelect.innerHTML = '<option value="">-- All Degrees --</option>';
      
      if (!university) return;
      
      try {
        const response = await fetch(`/api/get_schools?university=${encodeURIComponent(university)}`);
        const data = await response.json();
        
        data.schools.forEach(school => {
          const option = document.createElement('option');
          option.value = school;
          option.textContent = school;
          schoolSelect.appendChild(option);
        });
      } catch (e) {
        console.error('Error loading schools:', e);
      }
    }
    
    async function updateDegrees() {
      const university = document.getElementById('universitySelect').value;
      const school = document.getElementById('schoolSelect').value;
      const degreeSelect = document.getElementById('degreeSelect');
      
      degreeSelect.innerHTML = '<option value="">-- All Degrees --</option>';
      
      if (!university) return;
      
      try {
        let url = `/api/get_degrees?university=${encodeURIComponent(university)}`;
        if (school) {
          url += `&school=${encodeURIComponent(school)}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        data.degrees.forEach(degree => {
          const option = document.createElement('option');
          option.value = degree;
          option.textContent = degree;
          degreeSelect.appendChild(option);
        });
      } catch (e) {
        console.error('Error loading degrees:', e);
      }
    }

    async function updateDegreesF5() {
      const university = document.getElementById('universitySelectF5').value;
      const degreeSelect = document.getElementById('degreeSelectF5');
      
      degreeSelect.innerHTML = '<option value="">-- All Degrees --</option>';
      
      if (!university) return;
      
      try {
        const response = await fetch(`/api/get_degrees?university=${encodeURIComponent(university)}`);
        const data = await response.json();
        
        data.degrees.forEach(degree => {
          const option = document.createElement('option');
          option.value = degree;
          option.textContent = degree;
          degreeSelect.appendChild(option);
        });
      } catch (e) {
        console.error('Error loading degrees:', e);
      }
    }

    {% if active_tab == 'overview' %}
    const PREVIEW_ROWS = 50;

    function setActive(tabId){
      document.getElementById('tab-processed').classList.remove('active');
      document.getElementById('tab-raw').classList.remove('active');
      document.getElementById(tabId).classList.add('active');
    }

    async function loadCSV(path, label) {
      const status = document.getElementById('status');
      const table = document.getElementById('table');
      const selected = document.getElementById('selected');
      const filesize = document.getElementById('filesize');
      const totalrows = document.getElementById('totalrows');
      const tableTitle = document.getElementById('tableTitle');
      const downloadBtn = document.getElementById('downloadBtn');

      if (path.includes("cleaned.csv")) setActive("tab-processed");
      if (path.includes("raw.csv")) setActive("tab-raw");

      table.innerHTML = "";
      status.textContent = "Loading preview‚Ä¶";
      selected.textContent = label;
      tableTitle.textContent = label;
      filesize.textContent = "‚Äî";
      totalrows.textContent = "‚Äî";
      downloadBtn.href = path;

      try {
        try {
          const head = await fetch(path, { method: "HEAD" });
          if (head.ok) {
            const len = head.headers.get("content-length");
            if (len) filesize.textContent = humanBytes(Number(len));
          }
        } catch (_) {}

        const res = await fetch(path);
        if (!res.ok) throw new Error("HTTP " + res.status + " for " + path);
        const text = await res.text();

        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        const total = Math.max(0, lines.length - 1);
        totalrows.textContent = total.toLocaleString();

        const maxLines = Math.min(lines.length, PREVIEW_ROWS + 1);
        const rows = [];
        for (let i = 0; i < maxLines; i++) rows.push(lines[i].split(","));

        const header = rows[0];
        let html = "<thead><tr>" + header.map(h => `<th>${escapeHtml(h)}</th>`).join("") + "</tr></thead><tbody>";

        for (let r = 1; r < rows.length; r++) {
          html += "<tr>" + rows[r].map(c => `<td>${escapeHtml(c)}</td>`).join("") + "</tr>";
        }
        html += "</tbody>";
        table.innerHTML = html;

        status.textContent = `Loaded. Showing ${Math.max(0, rows.length - 1)} preview rows.`;
      } catch (e) {
        status.textContent = "Error: " + e.message;
      }
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function humanBytes(bytes) {
      if (!Number.isFinite(bytes) || bytes < 0) return "‚Äî";
      const units = ["B", "KB", "MB", "GB"];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
    }

    try {
      loadCSV('/data/cleaned.csv', 'Processed (cleaned.csv)');
    } catch(e) {
      console.error('Error initializing CSV preview:', e);
    }
    {% endif %}

    {% if active_tab == 'tab1' and data %}
    // Chart.js for Trend Analysis
    const trendData = {{ data | tojson }};
    const years = trendData.map(d => d.year);
    const employmentRates = trendData.map(d => d.employment_rate_overall);
    const ftPermRates = trendData.map(d => d.employment_rate_ft_perm);
    const salaries = trendData.map(d => d.gross_monthly_median);
    const employmentMA = trendData.map(d => d['employment_rate_overall_ma{{ rolling_window }}']);
    const ftPermMA = trendData.map(d => d['employment_rate_ft_perm_ma{{ rolling_window }}']);
    const salaryMA = trendData.map(d => d['gross_monthly_median_ma{{ rolling_window }}']);

    const chartOptions = {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      plugins: {
        legend: { 
          labels: { color: '#e9eefc', font: { size: 11 } }
        }
      },
      scales: {
        x: { 
          ticks: { color: '#a9b7da' },
          grid: { color: 'rgba(255,255,255,0.05)' }
        },
        y: { 
          ticks: { color: '#a9b7da' },
          grid: { color: 'rgba(255,255,255,0.08)' }
        }
      }
    };

    // Employment Rate Chart
    new Chart(document.getElementById('employmentChart'), {
      type: 'line',
      data: {
        labels: years,
        datasets: [{
          label: 'Employment Rate (%)',
          data: employmentRates,
          borderColor: '#6ea8fe',
          backgroundColor: 'rgba(110, 168, 254, 0.1)',
          tension: 0.3,
          fill: true
        }, {
          label: '{{ rolling_window }}-Year Moving Avg',
          data: employmentMA,
          borderColor: '#9b7bff',
          borderDash: [5, 5],
          tension: 0.3,
          fill: false
        }]
      },
      options: {
        ...chartOptions,
        plugins: {
          ...chartOptions.plugins,
          title: { display: true, text: 'Employment Rate Trend', color: '#e9eefc' }
        }
      }
    });

    // FT Permanent Rate Chart
    new Chart(document.getElementById('ftPermChart'), {
      type: 'line',
      data: {
        labels: years,
        datasets: [{
          label: 'FT Permanent Rate (%)',
          data: ftPermRates,
          borderColor: '#31d0aa',
          backgroundColor: 'rgba(49, 208, 170, 0.1)',
          tension: 0.3,
          fill: true
        }, {
          label: '{{ rolling_window }}-Year Moving Avg',
          data: ftPermMA,
          borderColor: '#9b7bff',
          borderDash: [5, 5],
          tension: 0.3,
          fill: false
        }]
      },
      options: {
        ...chartOptions,
        plugins: {
          ...chartOptions.plugins,
          title: { display: true, text: 'FT Permanent Employment Trend', color: '#e9eefc' }
        }
      }
    });

    // Salary Chart
    new Chart(document.getElementById('salaryChart'), {
      type: 'line',
      data: {
        labels: years,
        datasets: [{
          label: 'Median Salary ($)',
          data: salaries,
          borderColor: '#ffc107',
          backgroundColor: 'rgba(255, 193, 7, 0.1)',
          tension: 0.3,
          fill: true
        }, {
          label: '{{ rolling_window }}-Year Moving Avg',
          data: salaryMA,
          borderColor: '#9b7bff',
          borderDash: [5, 5],
          tension: 0.3,
          fill: false
        }]
      },
      options: {
        ...chartOptions,
        aspectRatio: 2.5,
        plugins: {
          ...chartOptions.plugins,
          title: { display: true, text: 'Median Salary Trend', color: '#e9eefc' }
        }
      }
    });
    {% endif %}

    {% if active_tab == 'tab4' and trend_data %}
    const degreeTrend = {{ trend_data | tojson }};
    const trendYears = degreeTrend.map(d => d.year);
    const trendSalary = degreeTrend.map(d => d.gross_monthly_median);
    const trendEmployment = degreeTrend.map(d => d.employment_rate_overall);

    new Chart(document.getElementById('employmentSalaryTrend'), {
      type: 'line',
      data: {
        labels: trendYears,
        datasets: [{
          label: 'Median Salary ($)',
          data: trendSalary,
          borderColor: '#ffc107',
          backgroundColor: 'rgba(255, 193, 7, 0.12)',
          tension: 0.3,
          fill: true,
          yAxisID: 'y'
        }, {
          label: 'Employment Rate (%)',
          data: trendEmployment,
          borderColor: '#6ea8fe',
          backgroundColor: 'rgba(110, 168, 254, 0.12)',
          tension: 0.3,
          fill: false,
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.2,
        plugins: {
          legend: { labels: { color: '#e9eefc', font: { size: 11 } } }
        },
        scales: {
          x: {
            ticks: { color: '#a9b7da' },
            grid: { color: 'rgba(255,255,255,0.05)' }
          },
          y: {
            position: 'left',
            title: { display: true, text: 'Median Salary ($)', color: '#a9b7da' },
            ticks: { color: '#a9b7da' },
            grid: { color: 'rgba(255,255,255,0.08)' }
          },
          y1: {
            position: 'right',
            title: { display: true, text: 'Employment Rate (%)', color: '#a9b7da' },
            ticks: { color: '#a9b7da' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
    {% endif %}

    {% if active_tab == 'tab5' and data and data|length > 0 %}
    // Chart.js for Salary Projection
    const projectionData = {{ data | tojson }};
    const degreeLabels = projectionData.map(d => d.degree.substring(0, 30) + (d.degree.length > 30 ? '...' : ''));
    const actualSalaries = projectionData.map(d => d.last_actual_median);
    const predictedSalaries = projectionData.map(d => d.predicted_median_2024);

    new Chart(document.getElementById('projectionChart'), {
      type: 'bar',
      data: {
        labels: degreeLabels,
        datasets: [{
          label: projectionData[0].last_year + ' Actual Median ($)',
          data: actualSalaries,
          backgroundColor: 'rgba(110, 168, 254, 0.6)',
          borderColor: '#6ea8fe',
          borderWidth: 1
        }, {
          label: '2024 Predicted Median ($)',
          data: predictedSalaries,
          backgroundColor: 'rgba(49, 208, 170, 0.6)',
          borderColor: '#31d0aa',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: projectionData.length > 10 ? 1.5 : 2,
        plugins: {
          legend: { 
            labels: { color: '#e9eefc', font: { size: 12 } }
          },
          title: {
            display: true,
            text: 'Salary Projections: Actual vs Predicted',
            color: '#e9eefc',
            font: { size: 14 }
          }
        },
        scales: {
          x: { 
            ticks: { color: '#a9b7da', font: { size: 10 } },
            grid: { color: 'rgba(255,255,255,0.05)' }
          },
          y: { 
            ticks: { color: '#a9b7da' },
            grid: { color: 'rgba(255,255,255,0.08)' },
            beginAtZero: true
          }
        }
      }
    });
    {% endif %}
  </script>
</body>
</html>
